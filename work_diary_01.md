---
author : "jihongwei"
tags : ["工作日志"]
date : 2021-01-22T11:24:00Z
title : "记一次线上bug"
---


## 1、用索引不是优化，而是必须

## 2、不要信任用户的输入


#### 事情的详细记录

&nbsp;&nbsp;api接口要查询数据库信息需要字段key，重构时发现前端在query参数内传了key,旧代码是python写，逻辑是没有在query内取，而是在认证信息内取的。那么重构到go的时候发现了query内的key，就直接在query内取值了。


&nbsp;&nbsp;事情就这样发生了，到线上之后发现有很多前端的请求没有传key。导致golang获取到key值为0，巧就巧在这了，查数据库的db层，判断key为0时候没有将其拼接到sql内，导致该查询没有走索引。


&nbsp;&nbsp;一连串连锁反应发生了，由于大量慢查询，导致从库cpu飙升。处理主库binlog发生了延迟。用户创建或修改数据之后出现查询不到新结果的情况。


&nbsp;&nbsp;综合来开，问题大概分为三个，前端传的参数若隐若现，http获取数据可以不依赖前端参数的，db层写出了不使用索引的sql。


&nbsp;&nbsp;平时在写代码的时候一定要注意是否使用了sql，这不能当做一个优化项，因为线上数据量很大，慢查询可能会导致很严重的后果。


&nbsp;&nbsp;代码的技术管理上如果使用了主从分离，应该记录并仔细判断查询走从库还是主库。关键数据，核心功能有必要的还是应该查主库的，或者是一主多从。已免出现不重要的语句使从库不可用，从而造成核心功能受损，查不出数据。如果滥用主库将会出现，不重要的语句使从库不可用导致主库写入数据失败，从而出现数据丢失的情况，这种情况比之前还要严重。

